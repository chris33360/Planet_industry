<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Idle Factory</title>
  <style>
    body {
  margin: 0;
  display: flex;
  background: #0f172a;
  color: #e2e8f0;
  font-family: Arial, sans-serif;
}

/* Panneau de gauche */
#leftPanel {
  width: 220px;
  background: #1e293b;
  padding: 10px;
  border-right: 2px solid #334155;
}

/* Grille centrée dans un conteneur fixe */
#grid {
  display: grid;
  grid-template-columns: repeat(20, 32px);
  gap: 2px;
  padding: 10px;
  margin: 0 auto;          /* centre la grille */
  background: #0f172a;
  border: 2px solid #334155;
  border-radius: 6px;
  width: fit-content;      /* empêche la grille de s'étaler */
}

/* Cases de la grille */
.cell {
  width: 32px;
  height: 32px;
  background: #334155;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
}

/* Tooltip */
#tooltip {
  position: fixed;
  background: #1e293b;
  color: #e2e8f0;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  pointer-events: none;
  display: none;
  box-shadow: 0 0 6px #0005;
  z-index: 1000;
}
// ----------------------
// CALCUL DES DÉBITS
// ----------------------
function computeRatePerSecond(resourceId) {
  let rate = 0;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {

      const id = grid[y][x].machine;
      if (!id) continue;

      const m = machines.find(m => m.id === id);

      // Foreuse
      if (id === "drill") {
        const nat = grid[y][x].natural;
        if (nat === resourceId) {
          rate += productionRates[nat];
        }
      }

      // Extracteur
      else if (id === "extractor") {
        if (resourceId === "water" && grid[y][x].natural === "water")
          rate += 2;
        if (resourceId === "oil" && grid[y][x].natural === "oil")
          rate += 0.5;
      }

      // Machines qui consomment
      else if (m.consumes) {
        if (m.consumes[resourceId])
          rate -= m.consumes[resourceId];

        if (m.produces === resourceId)
          rate += m.produceRate;
      }

      // Panneau solaire
      else if (id === "solar_panel_machine" && resourceId === "energy") {
        rate += 0.6;
      }

      // Tour solaire
      else if (id === "solar_tower" && resourceId === "energy") {
        let bonus = 0;

        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dx === 0 && dy === 0) continue;

            const nx = x + dx;
            const ny = y + dy;

            if (nx < 0 || nx >= gridWidth || ny < 0 || ny >= gridHeight) continue;

            if (grid[ny][nx].machine === "solar_panel_machine")
              bonus += 0.6;
          }
        }

        rate += bonus * 3;
      }
    }
  }

  return rate;
}

// ----------------------
// PRODUCTION AUTOMATIQUE
// ----------------------
function autoProductionTick() {
  for (let id in resources) {
    resources[id].amount += computeRatePerSecond(id) * 0.1;
  }
  renderResources();
}

setInterval(autoProductionTick, 100);

// ----------------------
// RENDU DE LA GRILLE
// ----------------------
function renderGrid() {
  const g = document.getElementById("grid");
  g.innerHTML = "";

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {

      const cell = document.createElement("div");
      cell.className = "cell";

      const tile = grid[y][x];

      if (tile.machine) {
        const m = machines.find(m => m.id === tile.machine);
        cell.textContent = m.emoji;
      } else {
        cell.textContent = resources[tile.natural].emoji;
      }

      cell.onclick = () => placeMachine(x, y);

      g.appendChild(cell);
    }
  }
}

// ----------------------
// PLACEMENT DES MACHINES
// ----------------------
function placeMachine(x, y) {
  if (!selectedMachine) return;

  const tile = grid[y][x];
  if (tile.machine) return;

  const m = machines.find(m => m.id === selectedMachine);

  // Vérification du terrain
  if (Array.isArray(m.needs)) {
    if (!m.needs.includes(tile.natural)) return;
  } else if (m.needs !== "none" && tile.natural !== m.needs) {
    return;
  }

  // Vérification du coût
  if (!canAfford(m.cost)) return;

  payCost(m.cost);
  tile.machine = selectedMachine;

  renderGrid();
  renderResources();
}

// ----------------------
// FONCTIONS COÛTS
// ----------------------
function canAfford(cost) {
  return Object.entries(cost).every(([res, amt]) => resources[res].amount >= amt);
}

function payCost(cost) {
  Object.entries(cost).forEach(([res, amt]) => resources[res].amount -= amt);
}

// ----------------------
// INITIALISATION
// ----------------------
renderMachines();
renderGrid();
renderResources();

  </style>
</head>

<body>

  <div id="leftPanel">
    <h3>Machines</h3>
    <div id="machineList"></div>

    <h3>Ressources</h3>
    <div id="resourceList"></div>
  </div>

  <div id="grid"></div>

  <div id="tooltip"></div>

  <script>
    /* JS dans les blocs C1, C2, C3 */
  </script>

</body>
</html>
