<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Jeu de gestion â€“ Carte 18x40</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    padding: 20px;
  }
  h1 { margin-top: 0; }

  .container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .panel {
    background: #1e293b;
    padding: 15px;
    border-radius: 8px;
    min-width: 260px;
    box-shadow: 0 0 0 1px #334155;
  }

  .row {
    display: flex;
    justify-content: space-between;
    margin: 6px 0;
  }

  button {
    background: #2563eb;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 4px;
  }

  button.selected {
    background: #16a34a;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(40, 32px);
    gap: 3px;
  }

  .cell {
    width: 32px;
    height: 32px;
    background: #334155;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    cursor: pointer;
    font-size: 20px;
    user-select: none;
  }

  .cell:hover {
    background: #475569;
  }
</style>
</head>
<body>

<h1>Carte 18Ã—40 â€“ Industrie & Ã‰nergie</h1>

<div class="container">

  <!-- Ressources -->
  <div class="panel">
    <h2>Ressources</h2>
    <div id="resources"></div>
  </div>

  <!-- Machines -->
  <div class="panel">
    <h2>Machines</h2>
    <div id="machines"></div>
  </div>

  <!-- Carte -->
  <div class="panel">
    <h2>Carte</h2>
    <div id="grid" class="grid"></div>
  </div>

</div>

<script>
/* ============================
   RESSOURCES
============================ */

const resources = {
  wood:      { name: "Bois", emoji: "ğŸªµ", amount: 100 },
  iron:      { name: "Fer", emoji: "ğŸ”˜", amount: 50 },
  stone:     { name: "Pierre", emoji: "ğŸª¨", amount: 50 },
  copper:    { name: "Cuivre", emoji: "ğŸŸ ", amount: 0 },
  coal:      { name: "Charbon", emoji: "âš«", amount: 0 },
  oil:       { name: "PÃ©trole", emoji: "ğŸ›¢ï¸", amount: 0 },
  aluminum:  { name: "Aluminium", emoji: "ğŸ§ª", amount: 0 },
  water:     { name: "Eau", emoji: "ğŸ’§", amount: 0 },
  uranium:   { name: "Uranium", emoji: "â˜¢ï¸", amount: 0 },
  crystal:   { name: "Cristal", emoji: "ğŸ”®", amount: 0 },
  energy:    { name: "Ã‰nergie", emoji: "âš¡", amount: 100 }
};

/* ============================
   DÃ‰BITS PAR SECONDE (brut)
============================ */

const productionRates = {
  water: 2,
  oil: 0.5,
  wood: 2,
  stone: 1.5,
  copper: 0.6,
  aluminum: 0.5,
  crystal: 0.6,
  uranium: 0.2,
  iron: 0.8
};

/* ============================
   MACHINES
============================ */

const machines = [
  {
    id: "sawmill",
    name: "Scierie",
    produces: "wood",
    emoji: "ğŸªš",
    needs: "forest",
    cost: { wood: 30, iron: 10 },
    power: 0.8
  },
  {
    id: "extractor_water",
    name: "Extracteur d'eau",
    produces: "water",
    emoji: "ğŸ’§",
    needs: "water",
    cost: { aluminum: 30, iron: 20 },
    power: 1.2
  },
  {
    id: "extractor_oil",
    name: "Extracteur de pÃ©trole",
    produces: "oil",
    emoji: "ğŸ›¢ï¸",
    needs: "oil",
    cost: { aluminum: 30, iron: 20 },
    power: 1.2
  },
  {
    id: "drill_iron",
    name: "Foreuse (Fer)",
    produces: "iron",
    emoji: "ğŸ”˜",
    needs: "iron",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "drill_stone",
    name: "Foreuse (Pierre)",
    produces: "stone",
    emoji: "ğŸª¨",
    needs: "stone",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "drill_copper",
    name: "Foreuse (Cuivre)",
    produces: "copper",
    emoji: "ğŸŸ ",
    needs: "copper",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "drill_aluminum",
    name: "Foreuse (Aluminium)",
    produces: "aluminum",
    emoji: "ğŸ§ª",
    needs: "aluminum",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "drill_crystal",
    name: "Foreuse (Cristal)",
    produces: "crystal",
    emoji: "ğŸ”®",
    needs: "crystal",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "drill_uranium",
    name: "Foreuse (Uranium)",
    produces: "uranium",
    emoji: "â˜¢ï¸",
    needs: "uranium",
    cost: { iron: 30 },
    power: 1
  },
  {
    id: "wood_to_coal",
    name: "Carboniseur",
    produces: "coal",
    consumes: { wood: 1 },
    produceRate: 0.8,
    emoji: "ğŸ”¥",
    needs: "none",
    cost: { wood: 20, stone: 10 },
    power: 0.3
  },
  {
    id: "coal_powerplant",
    name: "Centrale Ã  charbon",
    produces: "energy",
    consumes: { coal: 1 },
    produceRate: 3,
    emoji: "ğŸ­",
    needs: "none",
    cost: { iron: 40, stone: 20 },
    power: 0
  }
];

let selectedMachine = null;

/* ============================
   GRILLE 18Ã—40 AVEC RESSOURCES
============================ */

const gridWidth = 40;
const gridHeight = 18;

const resourceEmojis = {
  none: "",
  forest: "ğŸŒ²",
  iron: "ğŸ”˜",
  stone: "ğŸª¨",
  copper: "ğŸŸ ",
  aluminum: "ğŸ§ª",
  crystal: "ğŸ”®",
  uranium: "â˜¢ï¸",
  oil: "ğŸ›¢ï¸",
  water: "ğŸ’§"
};

// raretÃ© ajustÃ©e
function randomResource() {
  const r = Math.random();
  if (r < 0.55) return "none";
  if (r < 0.70) return "forest";
  if (r < 0.78) return "iron";
  if (r < 0.86) return "stone";
  if (r < 0.92) return "copper";
  if (r < 0.95) return "oil";
  if (r < 0.98) return "water";
  if (r < 0.995) return "aluminum";
  if (r < 0.999) return "crystal";
  return "uranium";
}

const grid = Array.from({ length: gridHeight }, () =>
  Array.from({ length: gridWidth }, () => ({
    machine: null,
    natural: randomResource()
  }))
);

/* ============================
   RENDU UI
============================ */

function computeRatePerSecond(resourceId) {
  let rate = 0;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const machineId = grid[y][x].machine;
      if (!machineId) continue;

      const machine = machines.find(m => m.id === machineId);
      if (!machine) continue;

      // Machines de transformation
      if (machine.consumes && machine.produces === resourceId) {
        rate += machine.produceRate;
      }
      // Machines d'extraction
      else if (!machine.consumes && machine.produces === resourceId) {
        rate += productionRates[resourceId] || 0;
      }
    }
  }

  return rate;
}

function renderResources() {
  const div = document.getElementById("resources");
  div.innerHTML = "";
  Object.entries(resources).forEach(([id, res]) => {
    const rate = computeRatePerSecond(id);
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>${res.emoji} ${res.name} (+${rate.toFixed(1)}/s)</span><span>${res.amount.toFixed(1)}</span>`;
    div.appendChild(row);
  });
}

function renderMachines() {
  const div = document.getElementById("machines");
  div.innerHTML = "";

  machines.forEach(machine => {
    const btn = document.createElement("button");

    let costText = Object.entries(machine.cost || {})
      .map(([res, amt]) => `${resources[res].emoji}${amt}`)
      .join(" ");

    btn.textContent = `${machine.emoji} ${machine.name}${costText ? " (" + costText + ")" : ""}`;

    btn.onclick = () => {
      selectedMachine = machine.id;
      renderMachines();
    };

    if (selectedMachine === machine.id) btn.classList.add("selected");

    div.appendChild(btn);
  });
}

function renderGrid() {
  const div = document.getElementById("grid");
  div.innerHTML = "";

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      const tile = grid[y][x];

      if (!tile.machine) {
        cell.textContent = resourceEmojis[tile.natural];
      } else {
        const m = machines.find(m => m.id === tile.machine);
        cell.textContent = m.emoji;
      }

      cell.onclick = () => placeMachine(x, y);

      cell.oncontextmenu = (e) => {
        e.preventDefault();
        removeMachine(x, y);
      };

      div.appendChild(cell);
    }
  }
}

/* ============================
   PLACEMENT / SUPPRESSION
============================ */

function canAfford(cost) {
  if (!cost) return true;
  return Object.entries(cost).every(([res, amount]) =>
    resources[res].amount >= amount
  );
}

function payCost(cost) {
  if (!cost) return;
  Object.entries(cost).forEach(([res, amount]) => {
    resources[res].amount -= amount;
  });
}

function placeMachine(x, y) {
  if (!selectedMachine) return;

  const tile = grid[y][x];
  if (tile.machine) return;

  const machine = machines.find(m => m.id === selectedMachine);
  if (!machine) return;

  if (machine.needs !== "none" && tile.natural !== machine.needs) return;

  if (!canAfford(machine.cost)) return;

  payCost(machine.cost);

  tile.machine = selectedMachine;
  renderGrid();
  renderResources();
}

function removeMachine(x, y) {
  grid[y][x].machine = null;
  renderGrid();
}

/* ============================
   PRODUCTION + Ã‰NERGIE
============================ */

function autoProductionTick() {

  let totalPowerNeeded = 0;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const machineId = grid[y][x].machine;
      if (!machineId) continue;

      const machine = machines.find(m => m.id === machineId);
      if (!machine) continue;
      totalPowerNeeded += machine.power;
    }
  }

  if (resources.energy.amount < totalPowerNeeded) {
    renderResources();
    return;
  }

  resources.energy.amount -= totalPowerNeeded;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const machineId = grid[y][x].machine;
      if (!machineId) continue;

      const machine = machines.find(m => m.id === machineId);
      if (!machine) continue;

      // Machines de transformation
      if (machine.consumes) {
        let canRun = true;

        for (const [res, amount] of Object.entries(machine.consumes)) {
          if (resources[res].amount < amount) {
            canRun = false;
            break;
          }
        }

        if (!canRun) continue;

        for (const [res, amount] of Object.entries(machine.consumes)) {
          resources[res].amount -= amount;
        }

        resources[machine.produces].amount += machine.produceRate;
      }
      // Machines dâ€™extraction
      else {
        const resId = machine.produces;
        const rate = productionRates[resId] || 0;
        resources[resId].amount += rate;
      }
    }
  }

  renderResources();
}

setInterval(autoProductionTick, 1000);

/* ============================
   INIT
============================ */

renderResources();
renderMachines();
renderGrid();

</script>

</body>
</html>
