<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Idle Factory</title>
<style>
  body {
    margin: 0;
    display: flex;
    background: #0f172a;
    color: #e2e8f0;
    font-family: Arial;
  }
  #leftPanel {
    width: 220px;
    background: #1e293b;
    padding: 10px;
    border-right: 2px solid #334155;
  }
  #grid {
    display: grid;
    gap: 2px;
    padding: 10px;
  }
  .cell {
    width: 32px;
    height: 32px;
    background: #334155;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
  }
  #techTree {
    width: 220px;
    background: #1e293b;
    padding: 10px;
    border-left: 2px solid #334155;
    overflow-y: auto;
  }
</style>
</head>

<body>

<div id="leftPanel">
  <h3>Machines</h3>
  <div id="machineList"></div>

  <h3>Ressources</h3>
  <div id="resourceList"></div>
</div>

<div id="grid"></div>

<div id="techTree">
  <h3>Arbre Technologique</h3>
  <div id="techList"></div>
</div>

<div id="tooltip" style="
  position: fixed;
  background: #1e293b;
  color: #e2e8f0;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  pointer-events: none;
  display: none;
  box-shadow: 0 0 6px #0005;
  z-index: 1000;
"></div>

<script>
// ----------------------
// RESSOURCES
// ----------------------
let resources = {
  stone: { name: "Pierre", emoji: "ü™®", amount: 0 },
  iron: { name: "Fer", emoji: "üîò", amount: 0 },
  copper: { name: "Cuivre", emoji: "üü†", amount: 0 },
  aluminum: { name: "Aluminium", emoji: "üß™", amount: 0 },
  crystal: { name: "Cristal", emoji: "üíé", amount: 0 },
  water: { name: "Eau", emoji: "üíß", amount: 0 },
  oil: { name: "P√©trole", emoji: "üõ¢Ô∏è", amount: 0 },
  glass: { name: "Verre", emoji: "üß´", amount: 0 },
  solar_panel: { name: "Panneau solaire", emoji: "üîÜ", amount: 0 },
  energy: { name: "√ânergie", emoji: "‚ö°", amount: 0 }
};

// ----------------------
// TAUX DE PRODUCTION
// ----------------------
let productionRates = {
  stone: 1.5,
  iron: 0.8,
  copper: 0.6,
  aluminum: 0.5,
  crystal: 0.6,
  glass: 1.8,
  solar_panel: 1
};

// ----------------------
// MACHINES
// ----------------------
let machines = [
  { id: "drill", name: "Foreuse", emoji: "‚õèÔ∏è", needs: ["stone","iron","copper","aluminum","crystal"], cost: { stone: 10 }, power: 1 },

  { id: "extractor", name: "Extracteur", emoji: "üíß", needs: ["water","oil"], cost: { stone: 15 }, power: 1 },

  { id: "glass_factory", name: "Verrerie", emoji: "üè∫",
    consumes: { crystal: 1 },
    produces: "glass",
    produceRate: 1.8,
    needs: "none",
    cost: { iron: 30, aluminum: 10 },
    power: 1.1
  },

  { id: "solar_factory", name: "Fabrique panneaux solaires", emoji: "üîß",
    consumes: { energy: 2, aluminum: 0.5, glass: 3 },
    produces: "solar_panel",
    produceRate: 1,
    needs: "none",
    cost: { aluminum: 100, glass: 20 },
    power: 0
  },

  { id: "solar_panel_machine", name: "Panneau solaire", emoji: "üîÜ",
    produces: "energy",
    produceRate: 0.6,
    needs: "none",
    cost: {},
    power: 0
  },

  { id: "solar_tower", name: "Tour solaire", emoji: "üóº",
    produces: "energy",
    produceRate: 0,
    needs: "none",
    cost: { aluminum: 80, glass: 20, stone: 10 },
    power: 0
  }
];

// ----------------------
// TECH TREE
// ----------------------
let techTiers = [
  { tier: 0, name: "Tier 0", cost: {}, bonus: 0, unlocked: true },
  { tier: 1, name: "Tier 1", cost: { iron: 50, stone: 50 }, bonus: 10, unlocked: false },
  { tier: 2, name: "Tier 2", cost: { aluminum: 40, glass: 20 }, bonus: 20, unlocked: false },
  { tier: 3, name: "Tier 3", cost: { crystal: 30, iron: 100 }, bonus: 30, unlocked: false },
  { tier: 4, name: "Tier 4", cost: { solar_panel: 10, aluminum: 150 }, bonus: 40, unlocked: false },
  { tier: 5, name: "Tier 5", cost: { glass: 200, crystal: 100 }, bonus: 50, unlocked: false }
];

// ----------------------
// GRILLE
// ----------------------
let gridWidth = 20;
let gridHeight = 20;

let grid = [];
for (let y = 0; y < gridHeight; y++) {
  grid[y] = [];
  for (let x = 0; x < gridWidth; x++) {
    grid[y][x] = {
      natural: ["stone","iron","copper","aluminum","crystal","water","oil"][Math.floor(Math.random()*7)],
      machine: null
    };
  }
}

// ----------------------
// RENDU DES MACHINES
// ----------------------
function renderMachines() {
  const list = document.getElementById("machineList");
  list.innerHTML = "";

  machines.forEach(machine => {
    const btn = document.createElement("button");
    btn.textContent = machine.emoji + " " + machine.name;

    btn.onmousemove = (e) => {
      tooltip.innerHTML = getMachineTooltip(machine);
      tooltip.style.left = (e.pageX + 15) + "px";
      tooltip.style.top = (e.pageY + 15) + "px";
      tooltip.style.display = "block";
    };
    btn.onmouseleave = () => tooltip.style.display = "none";

    btn.onclick = () => selectedMachine = machine.id;

    list.appendChild(btn);
  });
}

// ----------------------
// TOOLTIP
// ----------------------
function getMachineTooltip(machine) {
  let txt = `${machine.emoji} <b>${machine.name}</b><br>`;

  if (machine.id === "drill") {
    txt += `Produit selon ressource :<br>
    - Fer : +0.8/s<br>
    - Pierre : +1.5/s<br>
    - Cuivre : +0.6/s<br>
    - Aluminium : +0.5/s<br>
    - Cristal : +0.6/s<br>`;
  }
  else if (machine.id === "extractor") {
    txt += `Produit :<br>- Eau : +2/s<br>- P√©trole : +0.5/s<br>`;
  }
  else if (machine.id === "glass_factory") {
    txt += `Consomme : 1 üíé Cristal/s<br>Produit : +1.8 üß´ Verre/s<br>`;
  }
  else if (machine.id === "solar_factory") {
    txt += `Consomme :<br>- 2 ‚ö°/s<br>- 0.5 üß™/s<br>- 3 üß´/s<br>Produit : +1 üîÜ/s<br>`;
  }
  else if (machine.id === "solar_panel_machine") {
    txt += `Produit : +0.6 ‚ö°/s<br>`;
  }
  else if (machine.id === "solar_tower") {
    txt += `Produit : 3 √ó la production des panneaux solaires adjacents<br>
    Chaque panneau : +0.6 ‚ö°<br>`;
  }

  return txt;
}

// ----------------------
// TECH TREE RENDER
// ----------------------
function renderTechTree() {
  const list = document.getElementById("techList");
  list.innerHTML = "";

  techTiers.forEach(t => {
    const div = document.createElement("div");
    div.style.border = "1px solid #475569";
    div.style.padding = "8px";
    div.style.marginBottom = "8px";
    div.style.borderRadius = "6px";
    div.style.background = t.unlocked ? "#334155" : "#1e293b";

    let costText = Object.entries(t.cost)
      .map(([res, amt]) => `${resources[res].emoji}${amt}`)
      .join(" ");

    div.innerHTML = `
      <b>${t.name}</b><br>
      Bonus : +${t.bonus}%<br>
      Co√ªt : ${costText || "Aucun"}<br>
      √âtat : ${t.unlocked ? "D√©bloqu√©" : "Verrouill√©"}<br>
    `;

    if (!t.unlocked) {
      const btn = document.createElement("button");
      btn.textContent = "D√©bloquer";
      btn.onclick = () => unlockTechTier(t.tier);
      div.appendChild(btn);
    }

    list.appendChild(div);
  });
}

function unlockTechTier(tier) {
  const t = techTiers.find(x => x.tier === tier);
  if (!canAfford(t.cost)) return;
  payCost(t.cost);
  t.unlocked = true;
  renderTechTree();
  renderResources();
}

// ----------------------
// RESSOURCES
// ----------------------
function renderResources() {
  const list = document.getElementById("resourceList");
  list.innerHTML = "";

  for (let id in resources) {
    const r = resources[id];
    const rate = computeRatePerSecond(id);
    list.innerHTML += `${r.emoji} ${r.name} : ${r.amount.toFixed(1)} (${rate.toFixed(2)}/s)<br>`;
  }
}

function canAfford(cost) {
  return Object.entries(cost).every(([res, amt]) => resources[res].amount >= amt);
}

function payCost(cost) {
  Object.entries(cost).forEach(([res, amt]) => resources[res].amount -= amt);
}

// ----------------------
// CALCUL DES D√âBITS
// ----------------------
function computeRatePerSecond(resourceId) {
  let rate = 0;

  let globalBonus = techTiers
    .filter(t => t.unlocked)
    .reduce((sum, t) => sum + t.bonus, 0) / 100;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const id = grid[y][x].machine;
      if (!id) continue;

      const m = machines.find(m => m.id === id);

      // Foreuse
      if (id === "drill") {
        const nat = grid[y][x].natural;
        if (nat === resourceId) {
          rate += productionRates[nat] * (1 + globalBonus);
        }
      }

      // Extracteur
      else if (id === "extractor") {
        if (resourceId === "water" && grid[y][x].natural === "water")
          rate += 2 * (1 + globalBonus);
        if (resourceId === "oil" && grid[y][x].natural === "oil")
          rate += 0.5 * (1 + globalBonus);
      }

      // Machines qui consomment
      else if (m.consumes) {
        if (m.consumes[resourceId])
          rate -= m.consumes[resourceId];

        if (m.produces === resourceId)
          rate += m.produceRate * (1 + globalBonus);
      }

      // Panneau solaire
      else if (id === "solar_panel_machine" && resourceId === "energy") {
        rate += 0.6 * (1 + globalBonus);
      }

      // Tour solaire
      else if (id === "solar_tower" && resourceId === "energy") {
        let bonus = 0;
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dx === 0 && dy === 0) continue;
            const nx = x + dx, ny = y + dy;
            if (nx < 0 || nx >= gridWidth || ny < 0 || ny >= gridHeight) continue;
            if (grid[ny][nx].machine === "solar_panel_machine")
              bonus += 0.6;
          }
        }
        rate += bonus * 3 * (1 + globalBonus);
      }
    }
  }

  return rate;
}

// ----------------------
// PRODUCTION AUTOMATIQUE
// ----------------------
function autoProductionTick() {
  for (let id in resources) {
    resources[id].amount += computeRatePerSecond(id) * 0.1;
  }
  renderResources();
}

setInterval(autoProductionTick, 100);

// ----------------------
// GRILLE
// ----------------------
let selectedMachine = null;

function renderGrid() {
  const g = document.getElementById("grid");
  g.style.gridTemplateColumns = `repeat(${gridWidth}, 32px)`;
  g.innerHTML = "";

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      const tile = grid[y][x];

      if (tile.machine) {
        const m = machines.find(m => m.id === tile.machine);
        cell.textContent = m.emoji;
      } else {
        cell.textContent = resources[tile.natural].emoji;
      }

      cell.onclick = () => placeMachine(x, y);

      g.appendChild(cell);
    }
  }
}

function placeMachine(x, y) {
  if (!selectedMachine) return;

  const tile = grid[y][x];
  if (tile.machine) return;

  const m = machines.find(m => m.id === selectedMachine);

  if (Array.isArray(m.needs)) {
    if (!m.needs.includes(tile.natural)) return;
  } else if (m.needs !== "none" && tile.natural !== m.needs) {
    return;
  }

  if (!canAfford(m.cost)) return;

  payCost(m.cost);
  tile.machine = selectedMachine;

  renderGrid();
  renderResources();
}

// ----------------------
// RESSOURCES
// ----------------------
let resources = {
  stone: { name: "Pierre", emoji: "ü™®", amount: 0 },
  iron: { name: "Fer", emoji: "üîò", amount: 0 },
  copper: { name: "Cuivre", emoji: "üü†", amount: 0 },
  aluminum: { name: "Aluminium", emoji: "üß™", amount: 0 },
  crystal: { name: "Cristal", emoji: "üíé", amount: 0 },
  water: { name: "Eau", emoji: "üíß", amount: 0 },
  oil: { name: "P√©trole", emoji: "üõ¢Ô∏è", amount: 0 },
  glass: { name: "Verre", emoji: "üß´", amount: 0 },
  solar_panel: { name: "Panneau solaire", emoji: "üîÜ", amount: 0 },
  energy: { name: "√ânergie", emoji: "‚ö°", amount: 0 }
};

// ----------------------
// TAUX DE PRODUCTION
// ----------------------
let productionRates = {
  stone: 1.5,
  iron: 0.8,
  copper: 0.6,
  aluminum: 0.5,
  crystal: 0.6,
  glass: 1.8,
  solar_panel: 1
};

// ----------------------
// MACHINES
// ----------------------
let machines = [
  { id: "drill", name: "Foreuse", emoji: "‚õèÔ∏è", needs: ["stone","iron","copper","aluminum","crystal"], cost: { stone: 10 }, power: 1 },

  { id: "extractor", name: "Extracteur", emoji: "üíß", needs: ["water","oil"], cost: { stone: 15 }, power: 1 },

  { id: "glass_factory", name: "Verrerie", emoji: "üè∫",
    consumes: { crystal: 1 },
    produces: "glass",
    produceRate: 1.8,
    needs: "none",
    cost: { iron: 30, aluminum: 10 },
    power: 1.1
  },

  { id: "solar_factory", name: "Fabrique panneaux solaires", emoji: "üîß",
    consumes: { energy: 2, aluminum: 0.5, glass: 3 },
    produces: "solar_panel",
    produceRate: 1,
    needs: "none",
    cost: { aluminum: 100, glass: 20 },
    power: 0
  },

  { id: "solar_panel_machine", name: "Panneau solaire", emoji: "üîÜ",
    produces: "energy",
    produceRate: 0.6,
    needs: "none",
    cost: {},
    power: 0
  },

  { id: "solar_tower", name: "Tour solaire", emoji: "üóº",
    produces: "energy",
    produceRate: 0,
    needs: "none",
    cost: { aluminum: 80, glass: 20, stone: 10 },
    power: 0
  }
];

// ----------------------
// TECH TREE
// ----------------------
let techTiers = [
  { tier: 0, name: "Tier 0", cost: {}, bonus: 0, unlocked: true },
  { tier: 1, name: "Tier 1", cost: { iron: 50, stone: 50 }, bonus: 10, unlocked: false },
  { tier: 2, name: "Tier 2", cost: { aluminum: 40, glass: 20 }, bonus: 20, unlocked: false },
  { tier: 3, name: "Tier 3", cost: { crystal: 30, iron: 100 }, bonus: 30, unlocked: false },
  { tier: 4, name: "Tier 4", cost: { solar_panel: 10, aluminum: 150 }, bonus: 40, unlocked: false },
  { tier: 5, name: "Tier 5", cost: { glass: 200, crystal: 100 }, bonus: 50, unlocked: false }
];

// ----------------------
// GRILLE
// ----------------------
let gridWidth = 20;
let gridHeight = 20;

let grid = [];
for (let y = 0; y < gridHeight; y++) {
  grid[y] = [];
  for (let x = 0; x < gridWidth; x++) {
    grid[y][x] = {
      natural: ["stone","iron","copper","aluminum","crystal","water","oil"][Math.floor(Math.random()*7)],
      machine: null
    };
  }
}

// ----------------------
// RENDU DES MACHINES
// ----------------------
function renderMachines() {
  const list = document.getElementById("machineList");
  list.innerHTML = "";

  machines.forEach(machine => {
    const btn = document.createElement("button");
    btn.textContent = machine.emoji + " " + machine.name;

    btn.onmousemove = (e) => {
      tooltip.innerHTML = getMachineTooltip(machine);
      tooltip.style.left = (e.pageX + 15) + "px";
      tooltip.style.top = (e.pageY + 15) + "px";
      tooltip.style.display = "block";
    };
    btn.onmouseleave = () => tooltip.style.display = "none";

    btn.onclick = () => selectedMachine = machine.id;

    list.appendChild(btn);
  });
}

// ----------------------
// TOOLTIP
// ----------------------
function getMachineTooltip(machine) {
  let txt = `${machine.emoji} <b>${machine.name}</b><br>`;

  if (machine.id === "drill") {
    txt += `Produit selon ressource :<br>
    - Fer : +0.8/s<br>
    - Pierre : +1.5/s<br>
    - Cuivre : +0.6/s<br>
    - Aluminium : +0.5/s<br>
    - Cristal : +0.6/s<br>`;
  }
  else if (machine.id === "extractor") {
    txt += `Produit :<br>- Eau : +2/s<br>- P√©trole : +0.5/s<br>`;
  }
  else if (machine.id === "glass_factory") {
    txt += `Consomme : 1 üíé Cristal/s<br>Produit : +1.8 üß´ Verre/s<br>`;
  }
  else if (machine.id === "solar_factory") {
    txt += `Consomme :<br>- 2 ‚ö°/s<br>- 0.5 üß™/s<br>- 3 üß´/s<br>Produit : +1 üîÜ/s<br>`;
  }
  else if (machine.id === "solar_panel_machine") {
    txt += `Produit : +0.6 ‚ö°/s<br>`;
  }
  else if (machine.id === "solar_tower") {
    txt += `Produit : 3 √ó la production des panneaux solaires adjacents<br>
    Chaque panneau : +0.6 ‚ö°<br>`;
  }

  return txt;
}

// ----------------------
// TECH TREE RENDER
// ----------------------
function renderTechTree() {
  const list = document.getElementById("techList");
  list.innerHTML = "";

  techTiers.forEach(t => {
    const div = document.createElement("div");
    div.style.border = "1px solid #475569";
    div.style.padding = "8px";
    div.style.marginBottom = "8px";
    div.style.borderRadius = "6px";
    div.style.background = t.unlocked ? "#334155" : "#1e293b";

    let costText = Object.entries(t.cost)
      .map(([res, amt]) => `${resources[res].emoji}${amt}`)
      .join(" ");

    div.innerHTML = `
      <b>${t.name}</b><br>
      Bonus : +${t.bonus}%<br>
      Co√ªt : ${costText || "Aucun"}<br>
      √âtat : ${t.unlocked ? "D√©bloqu√©" : "Verrouill√©"}<br>
    `;

    if (!t.unlocked) {
      const btn = document.createElement("button");
      btn.textContent = "D√©bloquer";
      btn.onclick = () => unlockTechTier(t.tier);
      div.appendChild(btn);
    }

    list.appendChild(div);
  });
}

function unlockTechTier(tier) {
  const t = techTiers.find(x => x.tier === tier);
  if (!canAfford(t.cost)) return;
  payCost(t.cost);
  t.unlocked = true;
  renderTechTree();
  renderResources();
}

// ----------------------
// RESSOURCES
// ----------------------
function renderResources() {
  const list = document.getElementById("resourceList");
  list.innerHTML = "";

  for (let id in resources) {
    const r = resources[id];
    const rate = computeRatePerSecond(id);
    list.innerHTML += `${r.emoji} ${r.name} : ${r.amount.toFixed(1)} (${rate.toFixed(2)}/s)<br>`;
  }
}

function canAfford(cost) {
  return Object.entries(cost).every(([res, amt]) => resources[res].amount >= amt);
}

function payCost(cost) {
  Object.entries(cost).forEach(([res, amt]) => resources[res].amount -= amt);
}

// ----------------------
// CALCUL DES D√âBITS
// ----------------------
function computeRatePerSecond(resourceId) {
  let rate = 0;

  let globalBonus = techTiers
    .filter(t => t.unlocked)
    .reduce((sum, t) => sum + t.bonus, 0) / 100;

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const id = grid[y][x].machine;
      if (!id) continue;

      const m = machines.find(m => m.id === id);

      // Foreuse
      if (id === "drill") {
        const nat = grid[y][x].natural;
        if (nat === resourceId) {
          rate += productionRates[nat] * (1 + globalBonus);
        }
      }

      // Extracteur
      else if (id === "extractor") {
        if (resourceId === "water" && grid[y][x].natural === "water")
          rate += 2 * (1 + globalBonus);
        if (resourceId === "oil" && grid[y][x].natural === "oil")
          rate += 0.5 * (1 + globalBonus);
      }

      // Machines qui consomment
      else if (m.consumes) {
        if (m.consumes[resourceId])
          rate -= m.consumes[resourceId];

        if (m.produces === resourceId)
          rate += m.produceRate * (1 + globalBonus);
      }

      // Panneau solaire
      else if (id === "solar_panel_machine" && resourceId === "energy") {
        rate += 0.6 * (1 + globalBonus);
      }

      // Tour solaire
      else if (id === "solar_tower" && resourceId === "energy") {
        let bonus = 0;
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dx === 0 && dy === 0) continue;
            const nx = x + dx, ny = y + dy;
            if (nx < 0 || nx >= gridWidth || ny < 0 || ny >= gridHeight) continue;
            if (grid[ny][nx].machine === "solar_panel_machine")
              bonus += 0.6;
          }
        }
        rate += bonus * 3 * (1 + globalBonus);
      }
    }
  }

  return rate;
}

// ----------------------
// PRODUCTION AUTOMATIQUE
// ----------------------
function autoProductionTick() {
  for (let id in resources) {
    resources[id].amount += computeRatePerSecond(id) * 0.1;
  }
  renderResources();
}

setInterval(autoProductionTick, 100);

// ----------------------
// GRILLE
// ----------------------
let selectedMachine = null;

function renderGrid() {
  const g = document.getElementById("grid");
  g.style.gridTemplateColumns = `repeat(${gridWidth}, 32px)`;
  g.innerHTML = "";

  for (let y = 0; y < gridHeight; y++) {
    for (let x = 0; x < gridWidth; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      const tile = grid[y][x];

      if (tile.machine) {
        const m = machines.find(m => m.id === tile.machine);
        cell.textContent = m.emoji;
      } else {
        cell.textContent = resources[tile.natural].emoji;
      }

      cell.onclick = () => placeMachine(x, y);

      g.appendChild(cell);
    }
  }
}

function placeMachine(x, y) {
  if (!selectedMachine) return;

  const tile = grid[y][x];
  if (tile.machine) return;

  const m = machines.find(m => m.id === selectedMachine);

  if (Array.isArray(m.needs)) {
    if (!m.needs.includes(tile.natural)) return;
  } else if (m.needs !== "none" && tile.natural !== m.needs) {
    return;
  }

  if (!canAfford(m.cost)) return;

  payCost(m.cost);
  tile.machine = selectedMachine;

  renderGrid();
  renderResources();
}

// ----------------------
// INITIALISATION
// ----------------------
renderMachines();
renderGrid();
renderResources();
renderTechTree();

</script>

</body>
</html>
